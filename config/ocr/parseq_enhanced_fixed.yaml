# =============================================================================
# ðŸ”§ PARSeq Enhanced - ConfiguraÃ§Ã£o CORRIGIDA
# =============================================================================
# Baseado na anÃ¡lise de erros das estatÃ­sticas
# Data: 2025-10-19
# Principais mudanÃ§as:
# 1. Usar modelo BASE ao invÃ©s de TINY (multi-linha)
# 2. Preprocessamento mais agressivo
# 3. Line detector mais sensÃ­vel
# 4. NormalizaÃ§Ã£o geomÃ©trica/fotomÃ©trica ativada
# 5. PÃ³s-processamento contextual forte
# =============================================================================

engine: parseq_enhanced

# =============================================================================
# ðŸŽ¯ MODELO - MUDANÃ‡A CRÃTICA #1
# =============================================================================
# âŒ ANTES: parseq_tiny (20MB, rÃ¡pido, mas FALHA em multi-linha)
# âœ… AGORA: parseq (60MB, melhor para multi-linha e texto complexo)

model_variant: parseq  # ou 'parseq-base', 'base'

# Alternativas se precisar mais precisÃ£o:
# - parseq_patch16_224 (100MB, mais lento, mÃ¡xima precisÃ£o)

device: 'cuda'  # ou 'cpu' se nÃ£o tiver GPU

# =============================================================================
# ðŸ“ LINE DETECTOR - MUDANÃ‡A CRÃTICA #2
# =============================================================================
# Problema identificado: crops multi-linha sendo processados como linha Ãºnica
# SoluÃ§Ã£o: Ativar detecÃ§Ã£o de linhas com threshold mais baixo

line_detection:
  enabled: true
  method: 'projection'  # projection, morphology, ou hybrid
  
  # ParÃ¢metros ajustados para detectar mais linhas
  min_line_height: 8       # reduzido de 10 (detecta linhas menores)
  min_gap: 3               # reduzido de 5 (detecta gaps menores)
  merge_threshold: 5       # reduzido de 10 (evita merge excessivo)
  
  # CorreÃ§Ã£o de inclinaÃ§Ã£o (deskew)
  correct_skew: true
  max_skew_angle: 10       # aumentado de 5 (corrige mais inclinaÃ§Ã£o)
  
  # Debug (desabilitar em produÃ§Ã£o)
  save_debug: false

# =============================================================================
# ðŸ”§ NORMALIZAÃ‡ÃƒO - MUDANÃ‡A CRÃTICA #3
# =============================================================================
# Problema: Crops com perspectiva/rotaÃ§Ã£o/sombras causam confusÃ£o

geometric_normalization:
  enabled: true
  deskew: true
  max_angle: 10            # aumentado (corrige mais rotaÃ§Ã£o)
  perspective_warp: true   # corrige perspectiva
  target_height: 64        # aumentado de 32 (mais resoluÃ§Ã£o)

photometric_normalization:
  enabled: true
  denoise: true
  denoise_strength: 7      # aumentado de 5 (mais denoising)
  clahe: true              # equalizaÃ§Ã£o de histograma
  clahe_clip_limit: 3.0    # aumentado de 2.0
  shadow_removal: true     # NOVO - remove sombras
  binarize: false          # desabilitado (pode perder info)

# =============================================================================
# ðŸŽ¨ PREPROCESSING - MUDANÃ‡A CRÃTICA #4
# =============================================================================
# Problema: Preprocessamento padrÃ£o nÃ£o Ã© suficiente para crops ruins

preprocessing:
  # Resize inteligente
  resize_height: 64        # aumentado de 32
  maintain_aspect: true
  
  # Processamento adaptativo
  adaptive_threshold: true
  block_size: 15           # reduzido de 21 (mais fino)
  c_constant: 10           # ajustado
  
  # Morphologia (remove ruÃ­do)
  morphology: true
  kernel_size: 2           # reduzido de 3 (mais conservador)
  iterations: 1
  
  # Contrast & Sharpness
  enhance_contrast: true
  contrast_factor: 1.5     # aumentado de 1.2
  sharpen: true
  sharpen_amount: 1.5      # aumentado de 1.0
  
  # Background removal
  remove_background: true  # NOVO
  background_threshold: 0.8
  
  # InversÃ£o automÃ¡tica (se fundo escuro)
  auto_invert: true
  invert_threshold: 128

# =============================================================================
# ðŸ”„ ENSEMBLE & VARIANTS - MUDANÃ‡A CRÃTICA #5
# =============================================================================
# Problema: Modelo falhando em single-pass
# SoluÃ§Ã£o: Gerar mÃºltiplas variantes e fazer ensemble

ensemble:
  enabled: true
  num_variants: 5          # aumentado de 3
  
  # Variantes a gerar
  variants:
    - 'original'
    - 'enhanced_contrast'  # +30% contrast
    - 'sharpened'          # +50% sharpen
    - 'denoised'           # bilateral filter
    - 'inverted'           # preto/branco invertido
  
  # EstratÃ©gia de reranking
  rerank_strategy: 'confidence_length'  # ou 'voting', 'confidence'
  min_confidence_delta: 0.1              # threshold para aceitar variante

# =============================================================================
# ðŸ“ POSTPROCESSING - MUDANÃ‡A CRÃTICA #6
# =============================================================================
# Problema: ConfusÃµes 0â†”1, /â†”1, Lâ†”I, Oâ†”0
# SoluÃ§Ã£o: Mapeamento contextual agressivo

postprocessing:
  enabled: true
  
  # Mapeamento contextual de ambiguidades
  context_mapping:
    enabled: true
    # Regras especÃ­ficas para DATAS e LOTES
    rules:
      # Em contexto de data (dd/mm/yyyy)
      - pattern: '\d[IO]/\d'     # I ou O entre nÃºmeros â†’ 0
        replace: '0'
        context: 'date'
      
      - pattern: '\d[l|]/\d'     # l ou | entre nÃºmeros â†’ 1
        replace: '1'
        context: 'date'
      
      # Em contexto de LOTE
      - pattern: 'L[O0]TE'       # LOTE com O â†’ O
        replace: 'O'
        context: 'lot'
      
      - pattern: 'V[A4]L'        # VAL com A â†’ A
        replace: 'A'
        context: 'expiry'
  
  # Fuzzy matching para formatos conhecidos
  fuzzy_matching:
    enabled: true
    patterns:
      - 'LOTE'
      - 'VAL'
      - 'VENCE'
      - 'FAB'
      - 'ENV'
    max_distance: 2  # Levenshtein distance
  
  # CorreÃ§Ã£o de caracteres especÃ­ficos
  char_corrections:
    # NÃºmeros comumente confundidos
    'O': '0'  # quando em contexto numÃ©rico
    'I': '1'
    'l': '1'
    'Z': '2'
    'S': '5'
    'G': '6'
    'B': '8'
    
    # SÃ­mbolos
    '|': '/'
    '\\': '/'
    '-': '/'  # quando em contexto de data
  
  # RemoÃ§Ã£o de caracteres invÃ¡lidos
  strip_invalid: true
  valid_chars: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ/:. -'
  
  # NormalizaÃ§Ã£o de case
  uppercase: true  # forÃ§ar maiÃºsculas (menos ambiguidade)

# =============================================================================
# âš™ï¸ CONFIGURAÃ‡Ã•ES GERAIS
# =============================================================================

# ConfianÃ§a
confidence_threshold: 0.3  # reduzido de 0.5 (aceita mais resultados)

# Batch processing
batch_size: 1  # processar um crop por vez (mais estÃ¡vel)

# Timeout
max_processing_time: 5.0  # segundos por crop

# Cache
cache_models: true
cache_dir: 'models/parseq/cache'

# =============================================================================
# ðŸ› DEBUG & OUTPUT
# =============================================================================

output:
  save_preprocessed: true   # ATIVAR para debug
  save_variants: true       # salvar todas as variantes
  save_line_splits: true    # salvar splits de linha
  save_text_output: true
  
debug:
  verbose: true
  log_level: 'INFO'
  save_failed_crops: true   # crops com CER > 0.5

# =============================================================================
# ðŸ“Š MÃ‰TRICAS & VALIDAÃ‡ÃƒO
# =============================================================================

evaluation:
  calculate_cer: true
  calculate_wer: true
  save_confusion_matrix: true
  generate_report: true
